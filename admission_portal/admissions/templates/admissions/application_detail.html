{% extends 'admissions/base.html' %}

{% block title %}Review Application - {{ application.application_number }}{% endblock %}

{% block content %}
<div class="header-content">
    <h1>
        <i class="fas fa-file-medical"></i>
        Review Application
    </h1>
    <div class="application-meta">
        <span class="application-number">{{ application.application_number }}</span>
        <span class="status-badge status-{{ application.status|lower }}">
            {{ application.status|title }}
        </span>
    </div>
</div>

<div class="detail-grid">
    <!-- Application Information -->
    <div class="detail-card">
        <h3><i class="fas fa-info-circle"></i> Application Details</h3>
        <div class="detail-item">
            <label>Student:</label>
            <span>{{ application.student.get_full_name|default:application.student.username }}</span>
        </div>
        <div class="detail-item">
            <label>Email:</label>
            <span>{{ application.student.email }}</span>
        </div>
        <div class="detail-item">
            <label>Course:</label>
            <span>{{ application.course.name }} ({{ application.course.code }})</span>
        </div>
        <div class="detail-item">
            <label>Submitted Date:</label>
            <span>{{ application.submission_date|date:"F d, Y"|default:"Not submitted" }}</span>
        </div>
        <div class="detail-item">
            <label>Last Updated:</label>
            <span>{{ application.last_updated|date:"F d, Y H:i" }}</span>
        </div>
    </div>

    <!-- Academic Information -->
    <div class="detail-card">
        <h3><i class="fas fa-graduation-cap"></i> Academic Information</h3>
        <div class="detail-item">
            <label>Previous School:</label>
            <span>{{ application.previous_school }}</span>
        </div>
        <div class="detail-item">
            <label>Qualification:</label>
            <span>{{ application.previous_qualification }}</span>
        </div>
        <div class="detail-item">
            <label>Percentage:</label>
            <span class="{% if application.percentage_obtained >= application.course.min_percentage %}text-success{% else %}text-danger{% endif %}">
                <strong>{{ application.percentage_obtained }}%</strong>
            </span>
        </div>
        <div class="detail-item">
            <label>Year of Passing:</label>
            <span>{{ application.year_of_passing }}</span>
        </div>
        <div class="detail-item">
            <label>Course Requirement:</label>
            <span>Minimum {{ application.course.min_percentage }}%</span>
        </div>
        <div class="detail-item">
            <label>Eligibility:</label>
            <span>
                {% if application.is_eligible %}
                    <span class="status-badge status-approved">
                        <i class="fas fa-check-circle"></i> ELIGIBLE
                    </span>
                {% else %}
                    <span class="status-badge status-rejected">
                        <i class="fas fa-times-circle"></i> NOT ELIGIBLE
                    </span>
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Personal Information -->
    <div class="detail-card">
        <h3><i class="fas fa-user"></i> Personal Information</h3>
        <div class="detail-item">
            <label>Date of Birth:</label>
            <span>{{ application.date_of_birth|date:"F d, Y" }}</span>
        </div>
        <div class="detail-item">
            <label>Age:</label>
            <span>{{ application.date_of_birth|timesince }}</span>
        </div>
        <div class="detail-item">
            <label>Phone:</label>
            <span>{{ application.phone }}</span>
        </div>
        <div class="detail-item">
            <label>Emergency Contact:</label>
            <span>{{ application.emergency_contact }}</span>
        </div>
        <div class="detail-item">
            <label>Address:</label>
            <span class="multiline">{{ application.address }}</span>
        </div>
    </div>
</div>

<!-- Seat Availability Card -->
<div class="seat-availability-card">
    <div class="seat-info-header">
        <h3><i class="fas fa-chair"></i> Seat Availability</h3>
        <span class="course-code">{{ application.course.code }}</span>
    </div>
    <div class="seat-details">
        <div class="seat-stat">
            <span class="seat-label">Total Seats:</span>
            <span class="seat-value">{{ application.course.total_seats }}</span>
        </div>
        <div class="seat-stat">
            <span class="seat-label">Filled Seats:</span>
            <span class="seat-value">{{ application.course.filled_seats }}</span>
        </div>
        <div class="seat-stat">
            <span class="seat-label">Available Seats:</span>
            <span class="seat-value {% if application.course.available_seats > 0 %}text-success{% else %}text-danger{% endif %}">
                <strong>{{ application.course.available_seats }}</strong>
            </span>
        </div>
    </div>
    <div class="seat-progress">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ application.course.seat_percentage }}%"></div>
        </div>
        <span class="progress-text">{{ application.course.seat_percentage|floatformat:1 }}% Filled</span>
    </div>
    
    <!-- Seat Status Message -->
    <div class="seat-status-message">
        {% if application.course.available_seats <= 0 %}
            <div class="alert alert-danger mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>COURSE FULL!</strong> No seats available. Approval will add student to waitlist.
            </div>
        {% elif application.course.available_seats < 10 %}
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Limited Seats!</strong> Only {{ application.course.available_seats }} seats remaining.
            </div>
        {% else %}
            <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle"></i>
                <strong>Seats Available!</strong> {{ application.course.available_seats }} seats remaining.
            </div>
        {% endif %}
    </div>
</div>

<!-- REVIEW FORM - NO JAVASCRIPT! -->
<div class="review-form">
    <h3><i class="fas fa-clipboard-check"></i> Review Decision</h3>
    
    <form method="POST">
        {% csrf_token %}
        
        <div class="form-row">
            <div class="form-group">
                <label for="status" class="form-label">Application Status</label>
                <select id="status" name="status" class="form-control" required>
                    <option value="SUBMITTED" {% if application.status == 'SUBMITTED' %}selected{% endif %}>üìù Submitted</option>
                    <option value="UNDER_REVIEW" {% if application.status == 'UNDER_REVIEW' %}selected{% endif %}>‚è≥ Under Review</option>
                    <option value="APPROVED" {% if application.status == 'APPROVED' %}selected{% endif %}>‚úÖ Approved</option>
                    <option value="REJECTED" {% if application.status == 'REJECTED' %}selected{% endif %}>‚ùå Rejected</option>
                    <option value="WAITLISTED" {% if application.status == 'WAITLISTED' %}selected{% endif %}>‚è∏Ô∏è Waitlisted</option>
                    <option value="REQUIRES_DOCUMENTS" {% if application.status == 'REQUIRES_DOCUMENTS' %}selected{% endif %}>üìÑ Requires Documents</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Eligibility Override</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="is_eligible" name="is_eligible" class="form-check-input" 
                           {% if application.is_eligible %}checked{% endif %}>
                    <label for="is_eligible" class="form-check-label">
                        Mark as Eligible (Override automatic check)
                    </label>
                </div>
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Check this to manually mark student as eligible even if marks are below requirement.
                </small>
            </div>
        </div>

        <div class="form-group">
            <label for="review_notes" class="form-label">Review Notes</label>
            <textarea id="review_notes" name="review_notes" class="form-control" 
                      rows="4" placeholder="Add your review comments, observations, or decisions...">{{ application.review_notes|default:'' }}</textarea>
        </div>

        <div class="form-group">
            <label for="eligibility_notes" class="form-label">Eligibility Notes</label>
            <textarea id="eligibility_notes" name="eligibility_notes" class="form-control" 
                      rows="3" placeholder="Add notes about eligibility criteria...">{{ application.eligibility_notes|default:'' }}</textarea>
        </div>

        <!-- ACTION BUTTONS - MULTIPLE FORMS APPROACH (NO JS) -->
        <div class="form-actions">
            <!-- FORM 1: Save Review -->
            <button type="submit" name="action" value="save" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Review
            </button>
            
            <!-- FORM 2: Approve & Allocate Seat (Separate form) -->
            {% if application.is_eligible and application.course.available_seats > 0 %}
                <button type="submit" name="action" value="approve_and_allocate" class="btn btn-success">
                    <i class="fas fa-check-circle"></i> ‚úÖ Approve & Allocate Seat
                </button>
            {% endif %}
            
            <!-- FORM 3: Approve Only (No Seat) -->
            {% if application.is_eligible %}
                <button type="submit" name="action" value="approve_only" class="btn btn-info">
                    <i class="fas fa-check"></i> Approve (No Seat)
                </button>
            {% endif %}
            
            <!-- FORM 4: Reject Application -->
            <button type="submit" name="action" value="reject" class="btn btn-danger">
                <i class="fas fa-times-circle"></i> ‚ùå Reject
            </button>
            
            <!-- Back Button -->
            <a href="{% url 'manage_applications' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </form>
</div>

<!-- Seat Allocation Status - Show if already allocated -->
{% if application.seat_allocation %}
<div class="seat-allocation-status">
    <h3><i class="fas fa-check-circle"></i> Seat Allocation Details</h3>
    <div class="allocation-card">
        <div class="allocation-detail">
            <i class="fas fa-chair"></i>
            <strong>Seat Allocated:</strong>
            <span class="text-success">‚úÖ Yes</span>
        </div>
        <div class="allocation-detail">
            <i class="fas fa-calendar"></i>
            <strong>Allocation Date:</strong>
            <span>{{ application.seat_allocation.allocation_date|date:"F d, Y H:i" }}</span>
        </div>
        <div class="allocation-detail">
            <i class="fas fa-user-tie"></i>
            <strong>Allocated By:</strong>
            <span>{{ application.seat_allocation.allocated_by.get_full_name|default:application.seat_allocation.allocated_by.username }}</span>
        </div>
        <div class="allocation-detail">
            <i class="fas fa-check-double"></i>
            <strong>Confirmation Status:</strong>
            {% if application.seat_allocation.is_confirmed %}
                <span class="status-badge status-approved">Confirmed</span>
            {% else %}
                <span class="status-badge status-under_review">Pending Confirmation</span>
            {% endif %}
        </div>
        {% if application.seat_allocation.confirmation_deadline %}
        <div class="allocation-detail">
            <i class="fas fa-clock"></i>
            <strong>Confirmation Deadline:</strong>
            <span class="{% if application.seat_allocation.confirmation_deadline < today %}text-danger{% endif %}">
                {{ application.seat_allocation.confirmation_deadline|date:"F d, Y" }}
                {% if application.seat_allocation.confirmation_deadline < today %}
                    (Expired)
                {% endif %}
            </span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Review History -->
{% if application.reviewed_by %}
<div class="review-history">
    <h3><i class="fas fa-history"></i> Review History</h3>
    <div class="history-item">
        <div class="reviewer-info">
            <strong>{{ application.reviewed_by.get_full_name|default:application.reviewed_by.username }}</strong>
            <span class="review-date">{{ application.review_date|date:"F d, Y H:i" }}</span>
        </div>
        {% if application.review_notes %}
        <div class="review-content">
            <i class="fas fa-quote-left"></i>
            {{ application.review_notes }}
        </div>
        {% endif %}
        <div class="review-badges">
            <span class="status-badge status-{{ application.status|lower }}">
                {{ application.status|title }}
            </span>
            {% if application.seat_allocation %}
                <span class="status-badge status-approved">‚úÖ Seat Allocated</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}